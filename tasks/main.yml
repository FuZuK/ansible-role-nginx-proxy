---
- name: Add nginx stable repo
  apt_repository: repo=ppa:nginx/stable state=present update_cache=yes

- name: Install deps (apt)
  apt: name={{item}} state=present update-cache=yes cache_valid_time=864000
  with_items:
    - nginx-full
    - goaccess
    - python-passlib

- name: Create "/etc/nginx/ssl" dir
  file: 'path="/etc/nginx/ssl" mode=0700 state=directory'

- name: Copy SSL certificate to "/etc/nginx/ssl/{{nginx_proxy_configuration_name}}.cert"
  copy: 'src={{nginx_proxy_ssl_certificate}} dest="/etc/nginx/ssl/{{nginx_proxy_configuration_name}}.cert" mode=0600'
  notify: reload nginx
  when: nginx_proxy_ssl_certificate is defined and nginx_proxy_ssl_certificate.stat.exists

- name: Copy SSL certificate key to "/etc/nginx/ssl/{{nginx_proxy_configuration_name}}.key"
  copy: 'src={{nginx_proxy_ssl_certificate_key}} dest="/etc/nginx/ssl/{{nginx_proxy_configuration_name}}.key" mode=0600'
  notify: reload nginx
  when: nginx_proxy_ssl_certificate_key is defined and nginx_proxy_ssl_certificate_key.stat.exists

- name: Copy nginx configuration for "{{nginx_proxy_configuration_name}}"
  template: src=default.conf dest="/etc/nginx/sites-enabled/{{nginx_proxy_configuration_name}}"
  notify: reload nginx

- name: Ensure nginx started
  service: name=nginx state=started enabled=yes

- name: Add a user to a password file and ensure permissions are set
  htpasswd: 'path=/etc/nginx/passwdfile name={{nginx_proxy_user_name}} password={{nginx_proxy_htpasswd}} owner=root group=www-data mode=0640'
  when: nginx_proxy_htpasswd is defined and nginx_proxy_user_name is defined
  notify: reload nginx
